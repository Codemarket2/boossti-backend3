{"version":3,"file":"actionHelper.js","sourceRoot":"","sources":["actionHelper.ts"],"names":[],"mappings":"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","sourcesContent":["import moment from 'moment';\r\nimport { ClientSession } from 'mongoose';\r\nimport { systemForms } from '../permission/systemFormsConfig';\r\nimport { FormModel } from './formModel';\r\nimport { ResponseModel, responsePopulate } from './responseModel';\r\nimport { getValue } from './variables';\r\nimport generatePassword from 'generate-password';\r\n\r\n/**\r\n * @description Is used to get a Form Field's value by the fieldID of that field\r\n * @param1 fieldId is the field id of the form's field\r\n * @param2 values ???\r\n * */\r\nexport const getFieldValue = (fieldId, values) => {\r\n  return values.find((v) => v?.field === fieldId);\r\n};\r\n\r\nexport const getFieldValueByLabel = (label, fields, values) => {\r\n  const fieldId = fields?.find((f) => f?.label?.toLowerCase() === label?.toLowerCase())?._id;\r\n  const value = values?.find((v) => v?.field?.toString() === fieldId?.toString());\r\n  return value;\r\n};\r\n\r\ninterface IReplaceSchemaVariablesPayload {\r\n  variable: string;\r\n  form: any;\r\n  response: any;\r\n  userForm: any;\r\n}\r\n\r\nexport const replaceSchemaVariables = ({\r\n  variable,\r\n  form,\r\n  response,\r\n  userForm,\r\n}: IReplaceSchemaVariablesPayload) => {\r\n  variable = variable.split('{{formName}}').join(`${form?.name}`);\r\n  if (variable?.includes('{{createdBy}}')) {\r\n    const user = getUserAttributes(userForm, response?.createdBy);\r\n    let createdBy = user?.firstName;\r\n    if (createdBy && user?.lastName) {\r\n      createdBy += ` ${user?.lastName}`;\r\n    }\r\n    variable = variable.split('{{createdBy}}').join(createdBy || '');\r\n  }\r\n  // variable = variable.split('{{updatedBy}}').join(`${response?.updatedBy?.name || ''}`);\r\n  variable = variable.split('{{createdAt}}').join(`${moment(response?.createdAt).format('llll')}`);\r\n  variable = variable.split('{{updatedAt}}').join(`${moment(response?.updatedAt).format('llll')}`);\r\n  variable = variable.split('{{pageName}}').join(`${response?.parentId?.title || ''}`);\r\n  return variable;\r\n};\r\n\r\nexport interface IUserAttributes {\r\n  _id: string;\r\n  firstName: string;\r\n  lastName: string;\r\n  email: string;\r\n  name: string;\r\n}\r\n\r\nexport const getUserAttributes = (userForm: any, userResponse): IUserAttributes => {\r\n  const firstName = getFieldValueByLabel(\r\n    systemForms.users.fields.firstName,\r\n    userForm?.fields,\r\n    userResponse?.values,\r\n  )?.value;\r\n  const lastName = getFieldValueByLabel(\r\n    systemForms.users.fields.lastName,\r\n    userForm?.fields,\r\n    userResponse?.values,\r\n  )?.value;\r\n  const email = getFieldValueByLabel(\r\n    systemForms.users.fields.email,\r\n    userForm?.fields,\r\n    userResponse?.values,\r\n  )?.value;\r\n  let name = `${firstName}`;\r\n  if (lastName) {\r\n    name += ` ${lastName}`;\r\n  }\r\n  return { _id: userResponse?._id?.toString(), firstName, lastName, email, name };\r\n};\r\n\r\ninterface IReplaceVariablePayload {\r\n  subject?: string;\r\n  body?: string;\r\n  variables: any[];\r\n  fields: any[];\r\n  values: any[];\r\n  pageId: string;\r\n  senderEmail?: string;\r\n  templateId?: string;\r\n  session: ClientSession;\r\n  form: any;\r\n  response: any;\r\n}\r\n\r\nexport const replaceVariables = async ({\r\n  subject = '',\r\n  body = '',\r\n  variables,\r\n  fields,\r\n  values,\r\n  pageId,\r\n  senderEmail = '',\r\n  templateId,\r\n  session,\r\n  form,\r\n  response,\r\n}: IReplaceVariablePayload) => {\r\n  const formIds: any = [];\r\n  const forms: any = [];\r\n\r\n  variables?.forEach((variable: any) => {\r\n    if (variable.formId && !formIds.includes(variable.formId)) {\r\n      formIds.push(variable.formId);\r\n    }\r\n  });\r\n\r\n  for (const formId of formIds) {\r\n    if (formId?.toString() === form?._id?.toString()) {\r\n      forms.push({ ...form, response });\r\n    } else {\r\n      const tempForm = await FormModel.findById(formId).session(session);\r\n      const tempResponse = await ResponseModel.findOne({\r\n        formId,\r\n        parentId: pageId,\r\n        templateId,\r\n      })\r\n        .sort('-createdAt')\r\n        .populate(responsePopulate)\r\n        .session(session);\r\n      if (tempForm && tempResponse) {\r\n        forms.push({ ...tempForm?.toObject(), response: tempResponse });\r\n      }\r\n    }\r\n  }\r\n\r\n  variables = variables?.map((oneVariable) => {\r\n    const variable = { ...oneVariable, value: '' };\r\n    let field = null;\r\n    let value = null;\r\n    field = fields.find((f) => f._id?.toString() === variable?.field);\r\n    value = values.find((v) => v.field === variable?.field);\r\n\r\n    if (variable.formId) {\r\n      const form = forms.find((f) => f._id?.toString() === variable.formId);\r\n      if (form) {\r\n        field = form?.fields?.find((f) => f._id?.toString() === variable?.field);\r\n        value = form?.response?.values?.find((v) => v.field === variable?.field);\r\n      }\r\n    }\r\n    if (field && value) {\r\n      variable.value = getValue(field, value);\r\n    }\r\n    return variable;\r\n  });\r\n  variables.forEach((variable) => {\r\n    const variableName = `{{${variable.name}}}`;\r\n    const variableValue = variable.value || '';\r\n    if (body) {\r\n      body = body.split(variableName).join(variableValue);\r\n    }\r\n    if (subject) {\r\n      subject = subject.split(variableName).join(variableValue);\r\n    }\r\n    if (senderEmail) {\r\n      senderEmail = senderEmail.split(variableName).join(variableValue);\r\n    }\r\n  });\r\n  return { subject, body, senderEmail } as const;\r\n};\r\n\r\nexport const generateUserPassword = (options: Partial<generatePassword.GenerateOptions> = {}) => {\r\n  return generatePassword.generate({\r\n    length: 6,\r\n    strict: true,\r\n    uppercase: true,\r\n    lowercase: true,\r\n    numbers: false,\r\n    symbols: false,\r\n\r\n    ...options,\r\n  });\r\n};\r\n"]}