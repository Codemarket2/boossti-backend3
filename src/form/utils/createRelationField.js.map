{"version":3,"file":"createRelationField.js","sourceRoot":"","sources":["createRelationField.ts"],"names":[],"mappings":"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","sourcesContent":["import { IField } from '../types/form';\r\nimport { FormModel } from './formModel';\r\n\r\nexport const createRelationField = async (session, updatedForm, setForm) => {\r\n  const form = { ...updatedForm.toJSON() };\r\n  const childFields: IField[] = [];\r\n  const newFields = form?.fields?.map((field) => {\r\n    if (\r\n      field?.options?.createRelationField ||\r\n      field?.options?.updateRelationField ||\r\n      field?.options?.deleteRelationField\r\n    ) {\r\n      childFields.push(JSON.parse(JSON.stringify(field)));\r\n      const newField = { ...field };\r\n      delete newField?.options?.createRelationField;\r\n      delete newField?.options?.updateRelationField;\r\n      delete newField?.options?.deleteRelationField;\r\n      return newField;\r\n    }\r\n    return field;\r\n  });\r\n  if (childFields?.length > 0) {\r\n    for (let i = 0; i < childFields.length; i++) {\r\n      const field = childFields[i];\r\n      if (field?.options?.createRelationField) {\r\n        await FormModel.findOneAndUpdate(\r\n          { _id: field?.form?._id },\r\n          {\r\n            $push: {\r\n              fields: {\r\n                label: `${form?.name}_parent`,\r\n                fieldType: 'response',\r\n                form: form?._id,\r\n                options: { relationField: true, parentFormFieldId: field?._id },\r\n              },\r\n            },\r\n          },\r\n        ).session(session);\r\n      } else if (field?.options?.deleteRelationField) {\r\n        const childForm = await FormModel.findById(field?.options?.oldFormId).session(session);\r\n        if (childForm?._id) {\r\n          childForm.fields = childForm?.fields?.filter(\r\n            (f) => f?.options?.parentFormFieldId?.toString() !== field?._id?.toString(),\r\n          );\r\n          await childForm.save();\r\n        }\r\n      } else if (field?.options?.updateRelationField) {\r\n        const oldChildForm = await FormModel.findById(field?.options?.oldFormId).session(session);\r\n        if (oldChildForm?._id) {\r\n          oldChildForm.fields = oldChildForm?.fields?.filter(\r\n            (f) => f?.options?.parentFormFieldId?.toString() !== field?._id?.toString(),\r\n          );\r\n          await oldChildForm.save();\r\n        }\r\n        await FormModel.findOneAndUpdate(\r\n          { _id: field?.form?._id },\r\n          {\r\n            $push: {\r\n              fields: {\r\n                label: `${form?.name}_parent`,\r\n                fieldType: 'response',\r\n                form: form?._id,\r\n                options: { relationField: true, parentFormFieldId: field?._id },\r\n              },\r\n            },\r\n          },\r\n        ).session(session);\r\n      }\r\n    }\r\n    await FormModel.findOneAndUpdate(\r\n      { _id: updatedForm?._id },\r\n      {\r\n        fields: newFields,\r\n      },\r\n    ).session(session);\r\n    form.fields = newFields;\r\n  }\r\n  setForm(form);\r\n};\r\n"]}